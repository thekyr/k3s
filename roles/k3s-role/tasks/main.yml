---
- name: Download k3s installer
  get_url:
    url: https://get.k3s.io
    dest: /tmp/get_k3s.sh
    mode: '0755'

- name: Configure k3s master
  block:
    - name: Ensure k3s is not installed
      shell: |
        /usr/local/bin/k3s-uninstall.sh || true
      ignore_errors: yes
      when: "'masters' in group_names"

    - name: Install k3s binary on master
      shell: /tmp/get_k3s.sh
      environment:
        K3S_TOKEN: "supersecretoken"
          #K3S_TOKEN: !vault |
          #$ANSIBLE_VAULT;1.1;AES256
          #30666436616132333237303134383661306230323762656666393238386134336535383238306163
          #3339333430343163363036353564616133323334383666320a646339386337393631653731643238
          #35353865313165643066363232353863383464643062626236616232333537366335363436613932
          #6236353862623563380a626338393238346364303462656365393433666262323533656137396238
          #63373139336165356664383663643039326138383535643336666237366234303633323238663735
          #3561386265376635356134366563386633663563323133366466
        INSTALL_K3S_EXEC: "server \
                           --disable=traefik \
                           --flannel-backend=host-gw \
                           --tls-san={{ ansible_host }} \
                           --bind-address={{ ansible_host }} \
                           --advertise-address={{ ansible_host }} \
                           --node-ip={{ ansible_host }} \
                           --cluster-init"
      register: k3s_install_result
      changed_when: k3s_install_result.stdout != ""
      failed_when: k3s_install_result.rc != 0
      when: "'masters' in group_names"

    - name: Ensure k3s service is started and enabled
      systemd:
        name: k3s
        state: started
        enabled: yes
      when: "'masters' in group_names"

- name: Add worker nodes
  block:
    - name: Wait for master node token to be available
      wait_for:
        timeout: 30
      when: "'workers' in group_names"

    - name: Join worker node to the cluster
      shell: /tmp/get_k3s.sh agent
      environment:
        K3S_URL: "https://{{ hostvars['master0'].ansible_host }}:6443"
        K3S_TOKEN: "supersecretoken"
          #        K3S_TOKEN: !vault |
          #          $ANSIBLE_VAULT;1.1;AES256
          #          30666436616132333237303134383661306230323762656666393238386134336535383238306163
          #          3339333430343163363036353564616133323334383666320a646339386337393631653731643238
          #          35353865313165643066363232353863383464643062626236616232333537366335363436613932
          #          6236353862623563380a626338393238346364303462656365393433666262323533656137396238
          #          63373139336165356664383663643039326138383535643336666237366234303633323238663735
          #          3561386265376635356134366563386633663563323133366466
      register: k3s_install_result
      changed_when: k3s_install_result.stdout != ""
      failed_when: k3s_install_result.rc != 0
  when: "'workers' in group_names"
